# Execution Log

## [2026-02-05] Session Start
- **Action**: Initialized workspace and governance files.
- **Context**: "Phase 1" focus.
- **Observation**: `package.json` contains both `@monaco-editor/react` and `prosemirror-*`. `PLAN.md` prioritizes Monaco. `architect-log` noted `EditorView.tsx` uses ProseMirror.
- **Decision**: Established `PROJECT_BRIEF` and `STATE` based on `Plan/PLAN.md`.
- **[2026-02-05] Phase 1 Cleanup Complete**:
    - **Architecture**: Removed ProseMirror specific code (`EditorView.tsx`, `mistral-plugin.ts`, `editor.ts`) and uninstalled ~10 dependencies.
    - **Feature**: Ported `Ctrl+K` trigger to `MonacoEditor.tsx` using `addCommand`.
    - **Verification**: `npm run build` passed. `git diff` confirms clean state.
    - **Governance**: Addressed Council YellowLight via static analysis (confirmed no orphans).
- [2026-02-06] **Phase 1.5 Complete**: AI SDK implemented with Mistral support, Zod validation, and AICommandPalette UI. Build verified.
- [2026-02-06] **Phase 2 Start**: Transitioning focus to UI/UX Polish (Glassmorphism, Animations).
- [2026-02-06] **Phase 2: UI Overhaul (Blueprint Completion)**
  - **Action**: Implemented "Charcoal" aesthetic (#0d0e0d) across all core screens (Login, Dashboard, Modal, Loading, Editor).
  - **Tooling**: Strictly used Codex CLI for code generation as requested.
  - **Outcome**: `npm run build` passed. UI matches Blueprint specs (Austere, Code-Editor vibe).
- [2026-02-09] **UI Refinement + Functional Wiring Pass**
  - **Action**: Rebuilt `src/ui/EditorPage.tsx` to a Prism-style 3-pane editor with working controls, compile status, right-rail tabs (Preview/Assistant/Activity/Comments), actionable diagnostics, and local assistant/comment flows.
  - **Action**: Refined `src/ui/Dashboard.tsx` hierarchy (denser header controls, search affordance, visual consistency with editor shell).
  - **Verification**: `npm run build` and `npm test -- --run` both pass.
  - **Showcase**: Captured updated screens in `showcase/after/` (dashboard + editor tab states).
- [2026-02-09] **Total Overhaul Program Implementation (Phased Gates A-F in-review)**
  - **Phase 0 Artifacts**: Added `Plan/acceptance_thresholds.md`, `Plan/gate_scorecard.md`, `Plan/prism_parity_matrix.md`, `Plan/prism_parity_checklist.md`, `Plan/gate_self_critique.md`, `Plan/security_headers_and_csp.md`, and `Plan/baseline_behavior_map.md`.
  - **UI Overhaul (Phases 1-3)**: Applied hard-square tokenized design system across dashboard/editor/auth/workspace/modals/shared components. Updated `src/index.css` and `tailwind.config.js` for square-edge enforcement and unified primitives.
  - **Core/Backend Refactor (Phase 4)**: Added `DataStore`, `AuthService`, `CryptoVault`, `CompileService`, provider-id normalization, parity data types, and de-duplicated compile path scaffolding.
  - **Correctness Fixes**: Resolved magic-link token validation, removed `tex-compiler` self-import smell, and introduced session/master-key lifecycle handling including unlock route support.
  - **Security Hardening (Phase 5)**: Encrypted AI key persistence via vault, introduced AI egress policy checks, removed remote worker CDN import path, and added CSP baseline to `index.html`.
  - **Parity Stubs (Phase 6)**: Added near-term local stub contracts in `src/core/parity/featureStubs.ts`.
  - **Verification Constraint**: Runtime verification commands were not executable in this shell due missing `node`/`npm`.
- [2026-02-10] **Validation + Hotfix Session**
  - **Validation**: `npm run build` passes, `npm test -- --run` passes (4 files, 10 tests) after PATH-resolved Node execution.
  - **Incident**: Sign-in failures reproduced during manual testing.
  - **Root Cause**: HKDF extractability assumptions conflicted with WebCrypto behavior, causing auth key lifecycle breakage.
  - **Fixes**:
    - Restored non-extractable HKDF in `src/core/crypto.ts`.
    - Made wrapped master-key persistence best-effort/non-fatal in `src/core/auth/masterKeySession.ts` and `src/core/auth/AuthProvider.tsx`.
    - Added admin test-entry mode in `src/ui/auth/LoginScreen.tsx` and role handling in `src/core/storage/local.ts`.
  - **Documentation Update**: Meticulously refreshed `Plan/PLAN.md` and `Plan/ROADMAP_CHANGELOG.md` to reflect current program state, gate posture, and next sprint priorities.
- [2026-02-10] **Roadmap/Plan Meticulous Sync While Active Testing**
  - **Verification Refresh**:
    - Re-ran build with explicit Node path: `set PATH=C:\Progra~1\nodejs;%PATH% && C:\Progra~1\nodejs\npm.cmd run build` -> pass.
    - Re-ran tests with explicit Node path: `set PATH=C:\Progra~1\nodejs;%PATH% && C:\Progra~1\nodejs\npm.cmd test -- --run` -> pass (4 files, 10 tests).
    - Verified preview endpoint: `http://127.0.0.1:4173` responds `HTTP 200`.
  - **Operational Finding**:
    - Port `4173` listener confirmed (`node.exe`), so user-facing startup issues are likely collision/state related rather than missing build output.
  - **Benchmark Validation**:
    - Confirmed `https://openai.com/prism` reachable.
    - Confirmed legacy `https://openai.com/index/prism` is unstable (`404`) and documented as source-risk in parity planning.
- **Governance/File Sync**:
  - Updated `Plan/PLAN.md` with current evidence, risk posture, and active testing direction.
  - Updated `Plan/ROADMAP_CHANGELOG.md` with incident handling and serving diagnostics.
  - Updated `STATE.yaml` to remove stale toolchain-gap risk and add active preview/parity-link risks.
  - Updated gate/parity threshold artifacts to remove stale validation assumptions and align with current session truth.

## [2026-02-10] NVIDIA Build API (Kimi K2.5) Provider Wiring
- **Action**: Switched the backend AI adapter from OpenRouter assumptions to NVIDIA Build’s OpenAI-compatible endpoint.
- **Backend**:
  - Provider locked to `nvidia` for this phase.
  - Endpoint: `https://integrate.api.nvidia.com/v1/chat/completions`
  - Model default: `moonshotai/kimi-k2-5` (kept configurable).
  - Egress policy: strict `https` + allowlist (`integrate.api.nvidia.com`, `build.nvidia.com`).
- **Security**:
  - AI key stored encrypted at rest in local secret store; never logged.
  - `AI OFF` policy still blocks all outbound AI calls at the backend gate.
- [2026-02-10] **P0 Recovery Hard Reset + Meticulous Governance Refresh**
  - **Context**: User feedback flagged current editor as cluttered, directionless, and functionally unreliable.
  - **Implementation (UI/IA)**:
    - Replaced monolithic editor flow with shell-based composition:
      - `src/ui/editor-shell/EditorShell.tsx`
      - `src/ui/editor-shell/LeftRail.tsx`
      - `src/ui/editor-shell/ComposerPane.tsx`
      - `src/ui/editor-shell/ArtifactPane.tsx`
      - `src/ui/editor-shell/RunStatusBar.tsx`
      - `src/ui/editor-shell/RightDrawer.tsx`
      - `src/ui/editor-shell/contracts.ts`
    - Rewrote `src/ui/EditorPage.tsx` as orchestration container with:
      - agent-led composer-first flow,
      - unified drawer modes (project info/comments/logs/activity),
      - compile queue/debounce model (`idle/queued/compiling/success/error`),
      - persisted UI session state.
  - **Reliability**:
    - Stabilized Monaco runtime loading by configuring local loader path in `src/ui/editor/MonacoEditor.tsx`.
    - Copied Monaco runtime assets into `public/monaco/vs` for local CSP-safe loading.
    - Updated `src/ui/PdfViewer.tsx` placeholder behavior to tokenized layout.
  - **Dashboard Direction**:
    - Reworked `src/ui/Dashboard.tsx` to prioritize `Continue with AI` and `New agentic session`.
  - **Design Debt Cleanup**:
    - Removed legacy alias classes from `src/index.css` (`btn-pill-*`, `input-pill`, `selection-pill`, `center-card`).
    - Migrated `CenterCard` primitive use to `surface-card`.
  - **Types/Contracts Added**:
    - `src/core/editor/types.ts`
    - `src/core/ai/agenticTypes.ts`
    - Extended `src/core/compile/types.ts` and `src/core/data/types.ts` (`UiSessionState`).
  - **Validation**:
    - `npm run build` -> pass.
    - `npm test -- --run` -> pass (4 files, 10 tests).
    - `npx tsc --noEmit` -> fail due pre-existing strict-type baseline issues in unrelated legacy files.
  - **Runtime Serve**:
    - Port `4173` occupied by existing process.
    - Started and validated dev server on `http://127.0.0.1:4174` (`HTTP 200`).
  - **Governance Update**:
    - Meticulously refreshed `Plan/PLAN.md`, `Plan/ROADMAP_CHANGELOG.md`, `LOG.md`, `STATE.yaml`, and gate artifacts to reflect the new recovery posture and current risks.
- [2026-02-10] **Backend-First Competitor Slice Implemented (Control Plane + Rust Worker Path)**
  - **Backend Service**:
    - Added TypeScript local control plane under `backend/src` with versioned endpoints:
      - `GET /v1/health`
      - `POST/GET /v1/projects`
      - `GET /v1/projects/:id/files`
      - `PUT /v1/projects/:id/files/:path`
      - `POST /v1/compile/jobs`
      - `GET /v1/compile/jobs/:id`
      - `GET /v1/compile/jobs/:id/events`
      - `POST /v1/ai/chat`
      - `POST /v1/ai/edits`
      - `GET/PUT /v1/settings`
      - `PUT /v1/settings/ai-toggle`
  - **Compile Pipeline**:
    - Added backend compile queue service and worker invocation path in `backend/src/services/compileQueue.ts`.
    - Added Rust compile worker crate at `backend/rust/compile_worker` using `latexmk` and timeout handling.
    - Added filesystem artifact layout under `~/.cuboid` with compile jobs/events/build outputs.
  - **Security/Policy**:
    - Added encrypted local secret store (`backend/src/services/secrets.ts`) for OpenRouter API key.
    - Added AI policy gate with hard AI-off blocking and outbound domain allowlist enforcement.
  - **Frontend Wiring**:
    - Added backend API client in `src/core/backend/client.ts`.
    - Rewired editor compile path in `src/ui/EditorPage.tsx` to backend compile jobs.
    - Added global AI toggle wiring in composer (`src/ui/editor-shell/ComposerPane.tsx`) through settings API.
  - **Research Deliverables Added**:
    - `research/prism_crixet_feature_matrix.md`
    - `research/stack_alternatives_matrix.md`
    - `research/moat_and_differentiation.md`
    - `research/funding_narrative_mistral.md`
    - `research/source_log.md`
  - **Validation**:
    - `npm run build:backend` -> pass
    - `npm run build` -> pass
    - `npm test -- --run` -> pass (4 files, 10 tests)
    - `curl http://127.0.0.1:4317/v1/health` -> `HTTP 200`
- [2026-02-11] **Kimi/NVIDIA In-App Composer + Multimodal Wire-Up**
  - **Ambient AI Path**:
    - Completed bottom composer conversation flow in `src/ui/EditorPage.tsx` using `/v1/ai/chat`.
    - Added transcript rendering + clear behavior in `src/ui/editor-shell/ComposerPane.tsx`.
    - Wired image attach/remove for multimodal prompts.
  - **Editor-First Constraint Preserved**:
    - Kept AI hard toggle policy path (`AI OFF`) and no dependency of compile/editor paths on AI availability.
    - Kept explicit edit suggestions via `/v1/ai/edits` for edit/fix intents.
  - **Normalization/Resilience**:
    - Added response fallback parsing to read `reasoning` when `message.content` is null (`src/core/backend/client.ts`).
    - Added backend-side reasoning fallback for edit summary extraction (`backend/src/server.ts`).
    - Improved provider error details in `backend/src/services/aiRouter.ts`.
  - **Smoke/Validation**:
    - `npm run build:backend` pass.
    - `npm run build` pass.
    - `npm test -- --run` pass (4 files, 10 tests).
    - `scripts/validate_local.ps1` pass.
    - `scripts/test_kimi.ps1` pass (models + text + image + edits).
- [2026-02-11] **Phase 5: UI Refinements — Production Polish**
  - **CSS Design System**: Added cursor states, focus-visible rings, dropdown slide-in animation, pane restore handle, compile status dot with pulse animation.
  - **LeftRail**: Click-outside dismiss (useClickOutside hook), aria attrs, active file accent bar, chat empty state polish, section nesting indent.
  - **EditorShell**: Thin 4px restore handle (expands on hover), smooth grid transition, compile status pill.
  - **ArtifactPane**: Modified dot on unsaved tabs, middle-click close, 52px bottom padding for floating AI bar.
  - **ComposerPane**: Auto-scroll to latest message, backdrop-blur glass effect, growing textarea (max 4 lines), typing indicator with spinner.
  - **PdfViewer**: Click-outside menu dismiss, dark mode invert filter, polished empty state, aria accessibility.
  - **Contracts**: Added `isModified` to `EditorTab`, `pdfDarkMode` to `PreviewPaneProps`.
  - **Verification**: `npx tsc --noEmit` zero errors, `npx vite build` clean (282 kB JS, 54 kB CSS).

